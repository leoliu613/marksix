# Mark Six Adjacency Analysis

本專案檢驗一個假設：下一期的 7 個開出號碼是否傾向留在上一期 7 個號碼周圍的小範圍內（以 5×10 棋盤視覺化）。並且提供「是否將棋盤視為環面（wrap / 3×3 複製）」的比較，避免因邊界效果造成錯覺。

## 棋盤映射

| Column | Numbers |
|--------|---------|
| 1 | 1–10 |
| 2 | 11–20 |
| 3 | 21–30 |
| 4 | 31–40 |
| 5 | 41–50 (Mark Six 實際只用到 1–49，50 位置忽略) |

行（row）從底部往上 1..10。  
將號碼 n → (row=(n-1)%10+1, col=(n-1)//10+1)。  
你提供的單一 5×10 棋盤與 3×3 九宮格鋪排圖片（環面視覺化）對應此映射。

## 鄰近定義

- 使用 Chebyshev (King) 距離：距離 d = max(|Δrow|, |Δcol|)。
- 半徑 r ∈ {1,2}：
  - r=1 單點鄰域大小（無 wrap）角落最小 4～9，中央可達 9。
  - r=2 在中央可達 25 格（但實際有效號碼最多 49 內）。
- wrap=False：超出邊界截斷。
- wrap=True：環面（torus），距離採 min(|Δ|, 尺寸-|Δ|)，等價於你 3×3 複製示意。  
- exclude_center=True：從聯集鄰域去掉原種子號碼（排除「正中」），檢視是否只是重覆號帶來膨脹。

## 為何 r=2 wrap 幾乎沒有鑑別力

在 wrap 環面上，單一種子 r=2 鄰域為 5×5=25 格（扣除 50 號失效平均略低），7 個種子聯集期望覆蓋比例約：

P(某格未被任何種子覆蓋) ≈ (1 - 25/49)^7  
⇒ 覆蓋率 ≈ 1 - (24/49)^7 ≈ 99%（近似；實際會有重疊調整但仍非常高）

因此「下一期 7 個號碼中有 6~7 個落入聯集」只是因為聯集幾乎等於全集，並非真實相依。  
r=1 的聯集期望覆蓋才較小（約 37 格上下），適合看命中率是否偏離隨機基線。

## 統計方法

對每對相鄰期次 (t-1 → t)：
1. 建立 U = 上期 7 號碼的聯集鄰域。
2. hits = 下一期 7 號碼落在 U 的個數。
3. 基線：假設下一期獨立隨機從 1..49 選 7 個，成功集合大小 K=|U|。  
   - 期望 E[hits] = 7 * K / 49  
   - 方差 Var = 7 * (K/49) * (1 - K/49) * ((49-7)/(49-1)) （超幾何近似）。
4. 全期累積：Σhits、ΣE、ΣVar → z = (Σhits - ΣE)/sqrt(ΣVar)。  
   - |z| > 1.96 約對應雙尾顯著（p≈0.05）。

## 輸出解讀

`avg_U_cover_pct` 很高（尤其 r=2 wrap）表示規則太寬鬆。  
真正值得關注的是：
- r=1（no-wrap 或 wrap）是否顯示 hits 平均顯著高於期望？
- 排除正中後（exclude_center）是否仍顯著？

若所有 z 分數接近 0，代表「靠近上一期」現象與獨立隨機無異。  
若某一設定 z 顯著，需進一步做置換檢定或分段交叉驗證，避免偶然/過度擬合。

## 使用方式

```bash
python3 scripts/analyze_grid_adjacency.py lottery_result.json
```

會顯示：
- 六組配置統計（含 z 分數、平均聯集大小、命中直方圖）。
- 範例對：2025-10-23 → 2025-10-25（你之前觀察的那一期遷移）。

## 重要例子：2025-10-23 → 2025-10-25

上一期種子集中在高行，導致底行（1,11,21,31,41）未覆蓋；下一期出現 1 號即成為「唯一不在聯集」的案例。將棋盤 wrap 成環面後，底行也被折返覆蓋，1 號再度被納入，顯示 wrap 模型涵蓋力極大。

## CI 工作流程

GitHub Actions 檔 `.github/workflows/analyze.yml`：
- 在 push/PR 時自動執行分析腳本。
- 將 console 輸出儲存為 artifact `analysis-output` 以便檢視。
未來可加：
- 產生 JSON 統計摘要
- 上傳成 GitHub Pages 報告或生成圖表

## 未來延伸

- 置換檢定：打亂期次順序重算 hits 分佈。
- 更細距離階層：分別計算距離=0,1,2 的命中比率。
- 引入「多期衰減權重」：將 t-2, t-3 的種子鄰域以 w^Δt 加權。
- 使用 Bayesian 模型估計命中提升是否顯著。

## 檔案列表

- `lottery_result.json`：216 期原始資料（含末尾 placeholder 行；腳本會忽略）。
- `scripts/analyze_grid_adjacency.py`：主分析程式。
- `requirements.txt`：目前無外部套件。
- `.github/workflows/analyze.yml`：CI workflow。
- `README.md`：說明文件。

## 授權與注意

資料/圖片若來自外部來源，請確認你擁有分享權限。腳本僅做統計檢驗，不保證提供任何預測能力。

祝分析順利！如需我再補：  
- 產生圖表（命中率 vs 期次）  
- 加上置換檢定程式  
- 增加 CSV/JSON 結果輸出  

請提出即可。
