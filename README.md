# Mark Six Adjacency Analysis

本專案檢驗一個假設：下一期的 7 個開出號碼是否傾向留在上一期 7 個號碼周圍的小範圍內（以 5×10 棋盤視覺化）。並且提供「是否將棋盤視為環面（wrap / 3×3 複製）」的比較，避免因邊界效果造成錯覺。

## 棋盤映射 (Board Mapping)

將 Mark Six 號碼 1–49 映射到 5 列 × 10 行的棋盤：

| Column | Numbers |
|--------|---------|
| 1      | 1–10    |
| 2      | 11–20   |
| 3      | 21–30   |
| 4      | 31–40   |
| 5      | 41–50   |

- 行（row）從底部往上編號 1..10
- 列（col）從左到右編號 1..5
- 號碼 n 映射公式：row = (n-1) % 10 + 1, col = (n-1) // 10 + 1
- Mark Six 實際只使用 1–49，忽略位置 50（第 5 列第 10 行）

## 鄰近定義 (Adjacency Definition)

使用 Chebyshev 距離（國際象棋中王的移動規則）：

- **距離公式**：d = max(|Δrow|, |Δcol|)
- **半徑 r ∈ {1, 2}**：
  - r=1：單點鄰域（8 方向相鄰），大小依位置從 4（角落）到 9（中央）
  - r=2：擴展鄰域，中央可達 25 格（但實際有效號碼最多 49）

### 邊界處理模式

- **wrap=False（無環繞）**：超出邊界時截斷，邊緣號碼的鄰域較小
- **wrap=True（環面/torus）**：
  - 將棋盤視為環面（等價於 3×3 複製概念圖）
  - 距離計算：min(|Δ|, 尺寸 - |Δ|)，行用 10、列用 5
  - 消除邊界效應，所有位置的鄰域大小更均勻

### 排除中心選項

- **exclude_center=True**：從聯集鄰域中移除原種子號碼本身
- 目的：檢視「靠近」效果是否僅來自號碼重複，而非真正的空間相鄰性

## 為何 wrap r≤2 缺乏鑑別力 (Why wrap r≤2 lacks discriminative power)

在環面模式下，r=2 的單一種子鄰域約為 25 格（5×5 區域），7 個種子的聯集期望覆蓋率計算：

```
P(某格未被任何種子覆蓋) ≈ (1 - 25/49)^7
覆蓋率 ≈ 1 - (24/49)^7 ≈ 99%
```

**結論**：當聯集幾乎覆蓋全部 49 個號碼時，「下一期 6-7 個號碼落入聯集」只反映聯集過大，並非真實的空間依賴性。

**建議**：重點關注 r=1 的結果，其聯集期望覆蓋約 37 格（75%），更適合檢測是否存在顯著的鄰近偏好。

## 統計方法 (Statistical Method)

對每對連續期次 (t-1 → t)：

1. **建立聯集鄰域 U**：從上期 7 個號碼計算鄰域並合併
2. **計算命中數 hits**：本期 7 個號碼中有多少落在 U 內
3. **超幾何分佈基線**：
   - 假設下期獨立隨機從 49 個號碼中選 7 個
   - 成功集合大小 K = |U|
   - 期望值：E[hits] = 7 × K / 49
   - 方差：Var = 7 × (K/49) × (1 - K/49) × (42/48)
4. **累積 z-score**：
   - 將所有期次累加：Σhits、ΣE、ΣVar
   - z = (Σhits - ΣE) / √ΣVar
   - |z| > 1.96 約對應雙尾 p < 0.05（統計顯著）

## 輸出解讀 (Output Interpretation)

腳本輸出六種配置的統計結果：

1. **no-wrap r≤2 include center**：標準鄰域，含種子自身
2. **no-wrap r≤2 exclude center**：標準鄰域，排除種子自身
3. **no-wrap r≤1 include center**：緊鄰域（關鍵配置）
4. **wrap(3x3) r≤2 include center**：環面大鄰域（幾乎全覆蓋）
5. **wrap(3x3) r≤2 exclude center**：環面大鄰域，排除種子
6. **wrap(3x3) r≤1 include center**：環面緊鄰域

### 關鍵指標

- **avg_U_cover_pct**：聯集平均覆蓋百分比
  - 數值過高（>90%）表示規則太寬鬆，難以檢測真實效應
- **z_score**：標準化偏差
  - z ≈ 0：命中率與隨機期望一致
  - |z| > 1.96：可能存在顯著偏離（需進一步驗證）
- **hist_hits**：命中數分佈直方圖
  - 幫助判斷是集中趨勢還是極端值驅動

### 重點分析

- **r=1 配置**：期望覆蓋率適中（約 70-80%），最能反映真實鄰近性
- **排除中心後**：若 z-score 仍顯著，說明效應來自空間相鄰而非號碼重複
- **wrap vs no-wrap**：比較是否邊界效應造成假象

若所有配置的 z-score 都接近 0，表示「靠近上一期」現象與獨立隨機無統計學差異。

## 使用方式 (Usage)

```bash
python3 scripts/analyze_grid_adjacency.py lottery_result.json
```

腳本將輸出：
- 六組配置的完整統計（含 z-score、平均聯集大小、命中直方圖）
- 理論單點種子鄰域平均大小
- 範例配對分析（2025-10-23 → 2025-10-25）

## 重要範例：2025-10-23 → 2025-10-25

此配對展示了 wrap 與 no-wrap 的關鍵差異：

**上期號碼**：[4, 19, 24, 25, 26, 39, 46]（集中在較高行）
**下期號碼**：[1, 6, 7, 27, 36, 39, 43]

### no-wrap 模式 (r≤2)
- 聯集未覆蓋底行號碼（1, 11, 21, 31, 41）
- 號碼 1 落在聯集外 → hits = 6/7

### wrap 模式 (r≤2)
- 環面幾何使底行透過「折返」被上方種子覆蓋
- 號碼 1 被納入聯集 → hits = 7/7（|U| = 49，100% 覆蓋）

**結論**：此例說明 wrap r≤2 的超高覆蓋率導致幾乎所有配對都是全中，缺乏分辨力。

## CI 工作流程 (CI Workflow)

GitHub Actions 自動化檔案位於 `.github/workflows/analyze.yml`：

### 觸發條件
- `push`：任何分支推送
- `pull_request`：Pull Request 更新
- `workflow_dispatch`：手動觸發

### 執行步驟
1. Checkout 程式碼
2. 設置 Python 3.11 環境
3. 執行分析腳本，輸出同時顯示於 console 並存檔
4. 上傳 `analysis_output.txt` 為 artifact（名稱：`analysis-output`）

### 查看結果
- Actions 頁籤 → 選擇 workflow run → 下載 `analysis-output` artifact
- 可檢視完整的六組配置統計和範例輸出

## 未來延伸 (Future Extensions)

### 1. 置換檢定 (Permutation Test)
- 打亂期次順序，重新計算 hits 分佈
- 比較實際 z-score 與隨機分佈，評估 p 值準確性
- 避免過度擬合或偶然顯著性

### 2. 距離分層分析 (Distance Stratification)
- 分別統計距離 d=0（重複）、d=1、d=2 的命中比率
- 繪製命中率隨距離衰減曲線
- 更精細地判斷相依性的空間尺度

### 3. 多期衰減權重 (Multi-Period Decay)
- 引入 t-2, t-3 等更早期的種子鄰域
- 以指數衰減 w^Δt 加權（例如 w=0.5）
- 檢測長期記憶效應

### 4. Bayesian 層級模型
- 對每個配對的 hits 建立 Beta-Binomial 模型
- 估計全局提升參數及其可信區間
- 納入不確定性量化

### 5. 可視化與報告生成
- 生成命中率隨期次變化的折線圖
- 熱力圖展示不同 r 和 wrap 組合的 z-score
- 輸出 JSON/CSV 格式統計摘要
- 部署至 GitHub Pages 作為互動式報告

## 檔案列表 (Files)

```
marksix/
├── lottery_result.json              # 217 期開獎資料（含 1 行 placeholder）
├── scripts/
│   └── analyze_grid_adjacency.py    # 主分析程式
├── .github/
│   └── workflows/
│       └── analyze.yml              # CI workflow 配置
├── requirements.txt                 # Python 依賴（目前無外部套件）
└── README.md                        # 本說明文件
```

## 授權與免責聲明 (Disclaimer)

- **資料來源**：如使用外部彩票資料，請確認符合當地法規及資料提供者的使用條款
- **圖片版權**：概念圖片（棋盤映射、環面視覺化等）如來自第三方，請確保已取得授權或符合合理使用原則
- **無預測保證**：本專案純屬統計分析學習用途，不提供任何彩票預測能力，亦不鼓勵賭博行為
- **學術用途**：歡迎用於統計方法教學、空間分析研究等學術目的

## 技術支援 (Support)

如需進一步功能：
- 增加圖表生成（matplotlib/plotly）
- 實作置換檢定模組
- 輸出結構化資料（JSON/CSV）
- 整合其他彩票遊戲的棋盤映射

請提出 Issue 或 Pull Request！

---

**分析愉快！記得理性看待統計結果，享受探索資料的樂趣。** 🎲📊
